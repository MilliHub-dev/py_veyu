{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<style>
    #stats{
        grid-template-columns: repeat(auto-fill, minmax(calc(100%/2), 1fr));
        width: 100%;
        margin-bottom: 50px;
    }

    .block{
        display: block;
        width: 100%;
    }


    #charts{
        grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
        width: 100%;
    }

    @media screen and (min-width: 768px){ /* Tablets, PCs */
        #stats{
            grid-template-columns: repeat(auto-fill, minmax(calc(100%/3), 1fr));
        }
        #charts{
            grid-template-columns: repeat(auto-fill, minmax(calc(100%/3), 1fr));
        }
    }
    
    @media screen and (min-width: 1024px){ /* Tablets, PCs */
        #stats{
            grid-template-columns: repeat(auto-fill, minmax(calc(100%/5), 1fr));
        }
    }
</style>

<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
{% endblock %}




{% block content %}
<div class="block">    

    <!-- Stats Boxes -->
    <div id="stats" style="display: grid; width: 100%; gap: 20px;">
        <div style="flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>Customers</h4>
            <h1 style="font-weight: bold; color: #2563eb;">{{ metrics.total_customers|floatformat:0 }}</h1>
        </div>
        <div style="flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>Dealers</h4>
            <h1 style="font-weight: bold; color: #16a34a;">{{ metrics.total_dealers|floatformat:0 }}</h1>
        </div>
        <div style="flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>Orders</h4>
            <h1 style="font-weight: bold; color: #ea580c;">{{ metrics.total_orders|floatformat:0 }}</h1>
        </div>
        <div style="flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>Revenue</h4>
            <h1 style="font-weight: bold; color: #dc2626;">₦{{ metrics.total_revenue|floatformat:2 }}</h1>
        </div>
    </div>


    <!-- Charts Section -->
    <div id="charts" style="display: grid; gap: 20px; justify-content: space-between; margin-bottom: 20px;">
        <div style="flex: 1; min-width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>User Growth</h4>
            <br />
            <div style="position: relative; height: 300px; width: 100%;">
                <canvas id="userChart" ></canvas>
            </div>
        </div>
        <div style="flex: 1; min-width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>Orders & Revenue</h4>
            <br />
            <div style="position: relative; height: 300px; width: 100%;">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>


    <div>
        <h4> Dealerships Pending Approval </h4>
    </div>

    <div>
        <h4> Mechanics Pending Approval </h4>
    </div>
</div>

{{ monthly_data|default:{}|json_script:"admin-analytics-data" }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (window.__adminDashboardChartsInit) return;
        window.__adminDashboardChartsInit = true;

        let data = {};
        try { data = JSON.parse(document.getElementById('admin-analytics-data')?.textContent || '{}'); } catch(e) { data = {}; }

        const labels = Array.isArray(data.labels) ? data.labels : [];
        const customers = Array.isArray(data.customers) ? data.customers : [];
        const dealers = Array.isArray(data.dealers) ? data.dealers : [];
        const mechanics = Array.isArray(data.mechanics) ? data.mechanics : [];
        const orders = Array.isArray(data.orders) ? data.orders : [];
        const revenue = Array.isArray(data.revenue) ? data.revenue : [];

        const customer_increase = Array.isArray(data.customer_increase) ? data.customer_increase : [];
        const dealer_increase = Array.isArray(data.dealer_increase) ? data.dealer_increase : [];
        const mechanic_increase = Array.isArray(data.mechanic_increase) ? data.mechanic_increase : [];

        // User Growth Chart
        new Chart(document.getElementById('userChart').getContext('2d'), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Customers', data: customer_increase, backgroundColor: '#2563eb', borderColor: '#1d4ed8', borderWidth: 1, fill: false },
                    { label: 'Dealers', data: dealer_increase, backgroundColor: '#16a34a', borderColor: '#15803d', borderWidth: 1, fill: false },
                    { label: 'Mechanics', data: mechanic_increase, backgroundColor: '#ea580c', borderColor: '#d97706', borderWidth: 1, fill: false },
                ]
            },
            options: {
                responsive: true,
                aspectRatio: 1.75,
                maintainAspectRatio: false,
                plugins: { tooltip: { mode: 'index', intersect: false } },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Increase Count' } },
                    x: { title: { display: true, text: 'Date' } }
                }
            }
        });

        // Revenue Chart (Chart.js v3 scales)
        new Chart(document.getElementById('revenueChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Orders', data: orders, backgroundColor: '#ea580c', yAxisID: 'y1' },
                    { label: 'Revenue', data: revenue, backgroundColor: '#dc2626', yAxisID: 'y2', type: 'line' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y1: { type: 'linear', position: 'left', beginAtZero: true, title: { display: true, text: 'Number of Orders' } },
                    y2: { type: 'linear', position: 'right', beginAtZero: true, title: { display: true, text: 'Revenue (₦)' } }
                }
            }
        });
    });
</script>

{% endblock %}


