{% extends 'logs/base.html' %}

{% block title %}{{ log_file }} - Veyu Log Viewer{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">{{ log_file }}</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header with controls -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>
                <i class="fas fa-file-alt"></i> {{ log_file }}
            </h2>
            <div class="btn-group" role="group">
                <button id="toggleAutoRefresh" class="btn btn-outline-success">
                    <i class="fas fa-play"></i> Auto-refresh
                </button>
                <button id="manualRefresh" class="btn btn-outline-primary">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <a href="{% url 'logs:log_download' log_file %}" class="btn btn-outline-secondary">
                    <i class="fas fa-download"></i> Download
                </a>
            </div>
        </div>

        <!-- File info -->
        {% if file_info %}
        <div class="file-info">
            <div class="row">
                <div class="col-md-3">
                    <strong>Size:</strong> {{ file_info.size|filesizeformat }}
                </div>
                <div class="col-md-3">
                    <strong>Modified:</strong> {{ file_info.last_modified|date:"M d, Y H:i:s" }}
                </div>
                <div class="col-md-3">
                    <strong>Lines:</strong> {{ file_info.line_count|default:"Unknown" }}
                </div>
                <div class="col-md-3">
                    <span id="autoRefreshStatus" class="auto-refresh-indicator paused">
                        <i class="fas fa-pause"></i> Auto-refresh paused
                    </span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Search and filter controls -->
        <div class="card mb-3">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-6">
                        <label for="search" class="form-label">Search logs:</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ search_query }}" placeholder="Enter search terms...">
                    </div>
                    <div class="col-md-3">
                        <label for="level" class="form-label">Log Level:</label>
                        <select class="form-select" id="level" name="level">
                            <option value="">All Levels</option>
                            <option value="ERROR" {% if level_filter == 'ERROR' %}selected{% endif %}>ERROR</option>
                            <option value="WARNING" {% if level_filter == 'WARNING' %}selected{% endif %}>WARNING</option>
                            <option value="INFO" {% if level_filter == 'INFO' %}selected{% endif %}>INFO</option>
                            <option value="DEBUG" {% if level_filter == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search"></i> Filter
                        </button>
                        <a href="{% url 'logs:log_detail' log_file %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Error message display -->
        {% if error_message %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                {{ error_message }}
            </div>
        {% endif %}

        <!-- Large file warning -->
        {% if large_file_warning %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                {{ large_file_warning }}
            </div>
        {% endif %}

        <!-- Log content -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-terminal"></i> Log Content
                    {% if log_entries %}
                        <span class="badge bg-primary">{{ total_entries }} entries</span>
                    {% endif %}
                </h5>
                {% if search_query or level_filter %}
                <small class="text-muted">
                    Showing filtered results
                    {% if search_query %}for "{{ search_query }}"{% endif %}
                    {% if level_filter %}({{ level_filter }} level){% endif %}
                </small>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <div id="logContainer" class="log-container">
                    {% if log_entries %}
                        {% for entry in log_entries %}
                        <div class="log-entry log-level-{{ entry.level }}" data-line="{{ entry.line_number }}">
                            <span class="log-timestamp">{{ entry.timestamp|date:"H:i:s" }}</span>
                            <span class="log-level badge bg-dark">{{ entry.level }}</span>
                            <span class="log-message">{{ entry.message|safe }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">
                                {% if search_query or level_filter %}
                                    No log entries match your search criteria.
                                {% else %}
                                    No log entries found or file is empty.
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pagination -->
        {% if page_obj %}
        <nav aria-label="Log pagination" class="mt-3">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if level_filter %}&level={{ level_filter }}{% endif %}">
                            <i class="fas fa-angle-double-left"></i> First
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if level_filter %}&level={{ level_filter }}{% endif %}">
                            <i class="fas fa-angle-left"></i> Previous
                        </a>
                    </li>
                {% endif %}

                <li class="page-item active">
                    <span class="page-link">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                </li>

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if level_filter %}&level={{ level_filter }}{% endif %}">
                            Next <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if level_filter %}&level={{ level_filter }}{% endif %}">
                            Last <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let autoRefreshEnabled = false;
    let refreshInterval;
    const REFRESH_INTERVAL_MS = 30000; // 30 seconds

    // Auto-refresh functionality
    function toggleAutoRefresh() {
        const button = document.getElementById('toggleAutoRefresh');
        const status = document.getElementById('autoRefreshStatus');
        
        if (autoRefreshEnabled) {
            // Disable auto-refresh
            clearInterval(refreshInterval);
            autoRefreshEnabled = false;
            button.innerHTML = '<i class="fas fa-play"></i> Auto-refresh';
            button.className = 'btn btn-outline-success';
            status.innerHTML = '<i class="fas fa-pause"></i> Auto-refresh paused';
            status.className = 'auto-refresh-indicator paused';
        } else {
            // Enable auto-refresh
            autoRefreshEnabled = true;
            button.innerHTML = '<i class="fas fa-pause"></i> Auto-refresh';
            button.className = 'btn btn-success';
            status.innerHTML = '<i class="fas fa-play"></i> Auto-refresh active';
            status.className = 'auto-refresh-indicator';
            
            refreshInterval = setInterval(refreshLogContent, REFRESH_INTERVAL_MS);
        }
    }

    // Manual refresh functionality
    function refreshLogContent() {
        const logFile = '{{ log_file }}';
        const currentPage = {{ page_obj.number|default:1 }};
        const searchTerm = '{{ search_query|default:"" }}';
        const levelFilter = '{{ level_filter|default:"" }}';
        
        // Build API URL with current filters
        let apiUrl = `/logs/api/refresh/${logFile}/`;
        const params = new URLSearchParams();
        if (currentPage > 1) params.append('page', currentPage);
        if (searchTerm) params.append('search', searchTerm);
        if (levelFilter) params.append('level', levelFilter);
        
        if (params.toString()) {
            apiUrl += '?' + params.toString();
        }

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateLogContent(data.entries);
                    updateFileInfo(data.file_info);
                }
            })
            .catch(error => {
                console.error('Error refreshing log content:', error);
            });
    }

    // Update log content with new entries
    function updateLogContent(entries) {
        const container = document.getElementById('logContainer');
        const currentEntries = container.querySelectorAll('.log-entry');
        const currentLineNumbers = Array.from(currentEntries).map(entry => 
            parseInt(entry.getAttribute('data-line'))
        );
        
        entries.forEach(entry => {
            if (!currentLineNumbers.includes(entry.line_number)) {
                const entryElement = createLogEntryElement(entry);
                entryElement.classList.add('new-entry');
                container.appendChild(entryElement);
                
                // Remove highlight after 5 seconds
                setTimeout(() => {
                    entryElement.classList.remove('new-entry');
                }, 5000);
            }
        });
    }

    // Create log entry HTML element
    function createLogEntryElement(entry) {
        const div = document.createElement('div');
        div.className = `log-entry log-level-${entry.level}`;
        div.setAttribute('data-line', entry.line_number);
        
        div.innerHTML = `
            <span class="log-timestamp">${entry.timestamp}</span>
            <span class="log-level badge bg-dark">${entry.level}</span>
            <span class="log-message">${entry.message}</span>
        `;
        
        return div;
    }

    // Update file info display
    function updateFileInfo(fileInfo) {
        // Update file info if elements exist
        // This would be implemented based on the actual file info display structure
    }

    // Event listeners
    document.getElementById('toggleAutoRefresh').addEventListener('click', toggleAutoRefresh);
    document.getElementById('manualRefresh').addEventListener('click', refreshLogContent);

    // Scroll to bottom on page load if viewing latest entries
    {% if not page_obj or page_obj.number == 1 %}
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('logContainer');
        container.scrollTop = container.scrollHeight;
    });
    {% endif %}
</script>
{% endblock %}